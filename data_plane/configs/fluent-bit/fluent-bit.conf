# =============================================================================
# Fluent Bit Configuration - Data Plane Log Aggregation
# Forwards logs to Control Plane's Loki
# =============================================================================

[SERVICE]
    Flush         5
    Daemon        Off
    Log_Level     info
    Parsers_File  parsers.conf
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020
    Health_Check  On

# -----------------------------------------------------------------------------
# INPUTS
# -----------------------------------------------------------------------------

# Envoy access logs via Docker container logs (stdout JSON)
[INPUT]
    Name              tail
    Tag               envoy.access
    Path              /var/lib/docker/containers/*envoy*/*-json.log
    Parser            docker
    DB                /var/log/fluentbit/envoy-docker.db
    Mem_Buf_Limit     5MB
    Refresh_Interval  2
    Docker_Mode       On
    Docker_Mode_Flush 5

# Agent container stdout/stderr (TTY output, commands, errors)
[INPUT]
    Name              tail
    Tag               agent.tty
    Path              /var/lib/docker/containers/*agent*/*-json.log
    Parser            docker
    DB                /var/log/fluentbit/agent-docker.db
    Mem_Buf_Limit     10MB
    Refresh_Interval  1
    Docker_Mode       On
    Docker_Mode_Flush 2

# Agent application logs (if agent writes to /var/log/agent/)
[INPUT]
    Name              tail
    Tag               agent.app
    Path              /var/log/agent/*.log
    DB                /var/log/fluentbit/agent-app.db
    Mem_Buf_Limit     5MB
    Refresh_Interval  5

# Container metrics
[INPUT]
    Name          cpu
    Tag           metrics.cpu
    Interval_Sec  30

[INPUT]
    Name          mem
    Tag           metrics.mem
    Interval_Sec  30

# -----------------------------------------------------------------------------
# FILTERS
# -----------------------------------------------------------------------------

# Add data plane metadata to all logs
[FILTER]
    Name          record_modifier
    Match         *
    Record        source data_plane
    Record        hostname ${HOSTNAME}
    Record        environment ${ENVIRONMENT:-development}

# Tag agent TTY logs with stream type (stdout/stderr)
[FILTER]
    Name          record_modifier
    Match         agent.tty
    Record        log_type agent_tty

# Tag agent app logs
[FILTER]
    Name          record_modifier
    Match         agent.app
    Record        log_type agent_app

# Tag envoy logs
[FILTER]
    Name          record_modifier
    Match         envoy.*
    Record        log_type envoy_access

# -----------------------------------------------------------------------------
# OUTPUTS
# -----------------------------------------------------------------------------

# Primary: Push directly to Loki (high volume, low latency)
# Uses native Loki output plugin for proper label formatting
[OUTPUT]
    Name          loki
    Match         *
    Host          ${LOKI_HOST:-host.docker.internal}
    Port          ${LOKI_PORT:-3100}
    Labels        job=dataplane, source=fluent-bit, environment=${ENVIRONMENT:-development}
    Label_Keys    $log_type, $hostname
    Remove_Keys   log_type, hostname
    Line_Format   json
    Retry_Limit   5

# Local backup (in case Loki is unreachable)
[OUTPUT]
    Name          file
    Match         *
    Path          /var/log/fluentbit/backup/
    Format        json_lines
