# =============================================================================
# Vector Sinks - Connected Mode
# Ships logs to local OpenObserve (per-DP log store) and keeps a file backup.
# Used when DATAPLANE_MODE=connected.
# =============================================================================

sinks:
  # Local OpenObserve (per-DP log analytics)
  # Logs are stored locally and queryable by the warden API.
  # The CP queries warden via Cloudflare Tunnel for interactive tenants.
  log_store:
    type: http
    inputs:
      - parse_docker
      - parse_gvisor
      - parse_cell_app
    uri: "${OPENOBSERVE_URL:-http://log-store:5080}/api/default/cagent_logs/_json"
    method: post
    encoding:
      codec: json
    auth:
      strategy: basic
      user: "${OPENOBSERVE_USER:-admin@cagent.local}"
      password: "${OPENOBSERVE_PASSWORD}"
    batch:
      max_events: ${VECTOR_BATCH_MAX_EVENTS:-200}
      timeout_secs: ${VECTOR_BATCH_TIMEOUT_SECS:-10}
    request:
      headers:
        Content-Type: application/json
      rate_limit_num: 500
      rate_limit_duration_secs: 60
      retry_initial_backoff_secs: 2
      retry_max_duration_secs: 30

  # Local file backup (safety net if OO is temporarily down)
  file_backup:
    type: file
    inputs:
      - parse_docker
      - parse_gvisor
      - parse_cell_app
    path: /var/log/vector/backup/%Y-%m-%d.log
    encoding:
      codec: json
