# =============================================================================
# Vector Configuration - Data Plane Log Collection
# Collects from: Docker containers, gVisor audit logs, agent app logs
#
# Sources and transforms only. Sinks are in a separate file selected by
# DATAPLANE_MODE (see configs/vector/sinks/).
# =============================================================================

data_dir: /var/lib/vector

api:
  enabled: true
  address: "0.0.0.0:8686"

# =============================================================================
# SOURCES
# =============================================================================
sources:
  # Docker container logs (agent(s), envoy, coredns, agent-manager, email-proxy)
  # Vector's docker_logs source passes include_labels to the Docker API for
  # container discovery.  All monitored containers carry "cagent.log-collect=true".
  # NOTE: Docker API ANDs multiple label filters, so only ONE label is used here.
  docker_logs:
    type: docker_logs
    include_labels:
      - "cagent.log-collect=true"

  # gVisor debug/audit logs (security-critical)
  # Requires runsc configured with: --debug-log=/var/log/runsc/
  gvisor_logs:
    type: file
    include:
      - /var/log/runsc/**/*.log
    read_from: beginning
    fingerprint:
      strategy: device_and_inode

  # Agent application logs (custom app logging)
  agent_app_logs:
    type: file
    include:
      - /var/log/agent/**/*.log
    read_from: end

# =============================================================================
# TRANSFORMS
# =============================================================================
transforms:
  # Parse Docker logs and extract metadata
  parse_docker:
    type: remap
    inputs:
      - docker_logs
    source: |
      container = to_string(.container_name) ?? "unknown"

      .source = if contains(container, "http-proxy") {
        "envoy"
      } else if contains(container, "email-proxy") {
        "email-proxy"
      } else if contains(container, "agent-manager") {
        "agent-manager"
      } else if contains(container, "agent") {
        "agent"
      } else if contains(container, "dns") {
        "coredns"
      } else {
        "unknown"
      }

      .log_type = if .stream == "stderr" { "stderr" } else { "stdout" }

      msg = to_string(.message) ?? ""
      parsed, err = parse_json(msg)
      if err == null {
        .method = parsed.method
        .path = parsed.path
        .upstream_host = parsed.upstream_host
        .response_code = parsed.response_code
        .duration_ms = parsed.duration
        .bytes_sent = parsed.bytes_sent
        .bytes_received = parsed.bytes_received
        .request_id = parsed.request_id

        if .source == "envoy" && .method != "" {
          .log_type = "access"
        }
      }

      .hostname = get_env_var("HOSTNAME") ?? "unknown"
      .environment = get_env_var("ENVIRONMENT") ?? "development"

  # Parse gVisor logs (security audit)
  parse_gvisor:
    type: remap
    inputs:
      - gvisor_logs
    source: |
      .source = "gvisor"
      .hostname = get_env_var("HOSTNAME") ?? "unknown"
      .environment = get_env_var("ENVIRONMENT") ?? "development"

      msg = to_string(.message) ?? ""

      parsed, err = parse_regex(msg, r'^(?P<level>[IWEF])(?P<date>\d{4}) (?P<time>[\d:.]+)\s+(?P<pid>\d+)\s+(?P<file>[^:]+):(?P<line>\d+)\]\s*(?P<content>.*)$')

      if err == null {
        lvl = parsed.level
        .level = if lvl == "I" {
          "info"
        } else if lvl == "W" {
          "warning"
        } else if lvl == "E" {
          "error"
        } else {
          "fatal"
        }

        content = parsed.content

        syscall_match, serr = parse_regex(content, r'\[.*?\]\s+(?P<syscall>\w+)\(.*\)\s*=\s*(?P<result>.+)')
        if serr == null {
          .syscall = syscall_match.syscall
          result_str = string!(syscall_match.result)
          .syscall_result = if contains(result_str, "EPERM") || contains(result_str, "EACCES") || contains(result_str, "denied") {
            "denied"
          } else if contains(result_str, "errno") {
            "error"
          } else {
            "allowed"
          }
          .log_type = "syscall"
        } else {
          .log_type = "audit"
        }
      } else {
        .log_type = "debug"
        .level = "info"
      }

  # Parse agent app logs
  parse_agent_app:
    type: remap
    inputs:
      - agent_app_logs
    source: |
      .source = "agent"
      .log_type = "app"
      .hostname = get_env_var("HOSTNAME") ?? "unknown"
      .environment = get_env_var("ENVIRONMENT") ?? "development"

      msg = to_string(.message) ?? ""
      parsed, err = parse_json(msg)
      if err == null {
        .level = parsed.level
      } else {
        .level = "info"
      }
