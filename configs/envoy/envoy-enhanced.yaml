# =============================================================================
# Envoy Proxy Configuration - Enhanced
# Features: DNS filtering, request/response logging, credential injection
# =============================================================================

admin:
  address:
    socket_address:
      address: 127.0.0.1
      port_value: 9901

static_resources:
  listeners:
    # =========================================================================
    # DNS Proxy Listener (UDP 53)
    # Filters DNS queries to only allow approved domains
    # =========================================================================
    - name: dns_listener
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 53
          protocol: UDP
      listener_filters:
        - name: envoy.filters.udp_listener.udp_proxy
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.udp.udp_proxy.v3.UdpProxyConfig
            stat_prefix: dns
            matcher:
              on_no_match:
                action:
                  name: route
                  typed_config:
                    "@type": type.googleapis.com/envoy.extensions.filters.udp.udp_proxy.v3.Route
                    cluster: dns_upstream
            # DNS filtering is handled by external filter or upstream

    # =========================================================================
    # HTTPS Egress Listener with Full Logging
    # =========================================================================
    - name: egress_https
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 8443
      filter_chains:
        - filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: egress_https
                codec_type: AUTO

                # Access logging - JSON to stdout
                access_log:
                  - name: envoy.access_loggers.stdout
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.access_loggers.stream.v3.StdoutAccessLog
                      log_format:
                        json_format:
                          timestamp: "%START_TIME%"
                          authority: "%REQ(:AUTHORITY)%"
                          real_domain: "%REQ(X-REAL-DOMAIN)%"
                          path: "%REQ(:PATH)%"
                          method: "%REQ(:METHOD)%"
                          response_code: "%RESPONSE_CODE%"
                          response_flags: "%RESPONSE_FLAGS%"
                          credential_injected: "%REQ(X-CREDENTIAL-INJECTED)%"
                          rate_limited: "%REQ(X-RATE-LIMITED)%"
                          duration_ms: "%DURATION%"
                          bytes_received: "%BYTES_RECEIVED%"
                          bytes_sent: "%BYTES_SENT%"
                          upstream_cluster: "%UPSTREAM_CLUSTER%"
                          user_agent: "%REQ(USER-AGENT)%"
                          downstream_remote_address: "%DOWNSTREAM_REMOTE_ADDRESS%"

                route_config:
                  name: egress_routes
                  virtual_hosts:
                    # ---------------------------------------------------------
                    # GitHub API
                    # ---------------------------------------------------------
                    - name: github_api
                      domains:
                        - "api.github.com"
                        - "api.github.com:443"
                      routes:
                        - match:
                            prefix: "/"
                          route:
                            cluster: github_api
                            timeout: 30s
                          request_headers_to_add:
                            - header:
                                key: "X-Source"
                                value: "ai-devbox"

                    # ---------------------------------------------------------
                    # PyPI - Read only
                    # ---------------------------------------------------------
                    - name: pypi
                      domains:
                        - "pypi.org"
                        - "pypi.org:443"
                        - "files.pythonhosted.org"
                        - "files.pythonhosted.org:443"
                      routes:
                        # Block POST/PUT/DELETE (no uploads)
                        - match:
                            prefix: "/"
                            headers:
                              - name: ":method"
                                string_match:
                                  exact: "POST"
                          direct_response:
                            status: 403
                            body:
                              inline_string: "Upload to PyPI not allowed"
                        - match:
                            prefix: "/"
                            headers:
                              - name: ":method"
                                string_match:
                                  exact: "PUT"
                          direct_response:
                            status: 403
                            body:
                              inline_string: "Upload to PyPI not allowed"
                        # Allow GET
                        - match:
                            prefix: "/"
                          route:
                            cluster: pypi
                            timeout: 60s

                    # ---------------------------------------------------------
                    # HuggingFace
                    # ---------------------------------------------------------
                    - name: huggingface
                      domains:
                        - "huggingface.co"
                        - "huggingface.co:443"
                        - "*.huggingface.co"
                        - "*.huggingface.co:443"
                      routes:
                        - match:
                            prefix: "/"
                          route:
                            cluster: huggingface
                            timeout: 300s  # Large model downloads
                            max_stream_duration:
                              max_stream_duration: 600s

                    # ---------------------------------------------------------
                    # OpenAI API
                    # ---------------------------------------------------------
                    - name: openai
                      domains:
                        - "api.openai.com"
                        - "api.openai.com:443"
                      routes:
                        - match:
                            prefix: "/"
                          route:
                            cluster: openai_api
                            timeout: 120s

                    # ---------------------------------------------------------
                    # Anthropic API
                    # ---------------------------------------------------------
                    - name: anthropic
                      domains:
                        - "api.anthropic.com"
                        - "api.anthropic.com:443"
                      routes:
                        - match:
                            prefix: "/"
                          route:
                            cluster: anthropic_api
                            timeout: 120s

                    # ---------------------------------------------------------
                    # Devbox Local - HTTP to HTTPS upgrade with credentials
                    # Agent uses: curl http://api-openai-com.devbox.local/...
                    # Envoy upgrades to HTTPS and injects credentials
                    # ---------------------------------------------------------
                    - name: devbox_openai
                      domains:
                        - "api-openai-com.devbox.local"
                        - "api-openai-com.devbox.local:*"
                        - "openai.devbox.local"
                        - "openai.devbox.local:*"
                      routes:
                        - match:
                            prefix: "/"
                          route:
                            cluster: openai_api
                            timeout: 120s
                            auto_host_rewrite: true

                    - name: devbox_anthropic
                      domains:
                        - "api-anthropic-com.devbox.local"
                        - "api-anthropic-com.devbox.local:*"
                        - "anthropic.devbox.local"
                        - "anthropic.devbox.local:*"
                      routes:
                        - match:
                            prefix: "/"
                          route:
                            cluster: anthropic_api
                            timeout: 120s
                            auto_host_rewrite: true

                    - name: devbox_github
                      domains:
                        - "api-github-com.devbox.local"
                        - "api-github-com.devbox.local:*"
                        - "github.devbox.local"
                        - "github.devbox.local:*"
                      routes:
                        - match:
                            prefix: "/"
                          route:
                            cluster: github_api
                            timeout: 30s
                            auto_host_rewrite: true

                    - name: devbox_huggingface
                      domains:
                        - "huggingface-co.devbox.local"
                        - "huggingface-co.devbox.local:*"
                        - "huggingface.devbox.local"
                        - "huggingface.devbox.local:*"
                      routes:
                        - match:
                            prefix: "/"
                          route:
                            cluster: huggingface
                            timeout: 300s
                            auto_host_rewrite: true

                    # ---------------------------------------------------------
                    # Catch-all - Block with logging
                    # ---------------------------------------------------------
                    - name: blocked
                      domains:
                        - "*"
                      routes:
                        - match:
                            prefix: "/"
                          direct_response:
                            status: 403
                            body:
                              inline_string: '{"error": "destination_not_allowed", "message": "This domain is not in the allowlist"}'

                http_filters:
                  # ---------------------------------------------------------
                  # Lua Filter - Credential Injection + Rate Limiting + Security
                  # ---------------------------------------------------------
                  - name: envoy.filters.http.lua
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua
                      default_source_code:
                        filename: /etc/envoy/filter.lua

                  - name: envoy.filters.http.router
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

  clusters:
    # =========================================================================
    # Control Plane API (for credential lookup)
    # =========================================================================
    - name: control_plane_api
      type: STRICT_DNS
      connect_timeout: 5s
      lb_policy: ROUND_ROBIN
      load_assignment:
        cluster_name: control_plane_api
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: backend
                      port_value: 8000

    # =========================================================================
    # DNS Upstream (Filtered)
    # =========================================================================
    - name: dns_upstream
      type: STRICT_DNS
      connect_timeout: 2s
      lb_policy: ROUND_ROBIN
      load_assignment:
        cluster_name: dns_upstream
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: 8.8.8.8
                      port_value: 53

    # =========================================================================
    # External Service Clusters
    # =========================================================================
    - name: github_api
      type: LOGICAL_DNS
      connect_timeout: 10s
      lb_policy: ROUND_ROBIN
      circuit_breakers:
        thresholds:
          - priority: DEFAULT
            max_connections: 100
            max_pending_requests: 100
            max_requests: 100
            max_retries: 3
      load_assignment:
        cluster_name: github_api
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: api.github.com
                      port_value: 443
      transport_socket:
        name: envoy.transport_sockets.tls
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
          sni: api.github.com

    - name: pypi
      type: LOGICAL_DNS
      connect_timeout: 10s
      lb_policy: ROUND_ROBIN
      circuit_breakers:
        thresholds:
          - priority: DEFAULT
            max_connections: 50
            max_pending_requests: 50
            max_requests: 100
      load_assignment:
        cluster_name: pypi
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: pypi.org
                      port_value: 443
      transport_socket:
        name: envoy.transport_sockets.tls
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
          sni: pypi.org

    - name: huggingface
      type: LOGICAL_DNS
      connect_timeout: 10s
      lb_policy: ROUND_ROBIN
      circuit_breakers:
        thresholds:
          - priority: DEFAULT
            max_connections: 20
            max_pending_requests: 10
            max_requests: 30
      load_assignment:
        cluster_name: huggingface
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: huggingface.co
                      port_value: 443
      transport_socket:
        name: envoy.transport_sockets.tls
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
          sni: huggingface.co

    - name: openai_api
      type: LOGICAL_DNS
      connect_timeout: 10s
      lb_policy: ROUND_ROBIN
      circuit_breakers:
        thresholds:
          - priority: DEFAULT
            max_connections: 50
            max_pending_requests: 100
            max_requests: 60
      load_assignment:
        cluster_name: openai_api
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: api.openai.com
                      port_value: 443
      transport_socket:
        name: envoy.transport_sockets.tls
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
          sni: api.openai.com

    - name: anthropic_api
      type: LOGICAL_DNS
      connect_timeout: 10s
      lb_policy: ROUND_ROBIN
      circuit_breakers:
        thresholds:
          - priority: DEFAULT
            max_connections: 50
            max_pending_requests: 100
            max_requests: 60
      load_assignment:
        cluster_name: anthropic_api
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: api.anthropic.com
                      port_value: 443
      transport_socket:
        name: envoy.transport_sockets.tls
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
          sni: api.anthropic.com

layered_runtime:
  layers:
    - name: static_layer
      static_layer:
        envoy:
          resource_limits:
            listener:
              egress_https:
                connection_limit: 1000
